<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Votre_Boutique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #f59e0b;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --text-dark: #374151;
            --text-light: #6b7280;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: #f8f9fa;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 0;
        }

        .admin-sidebar {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
        }

        .admin-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
        }

        .nav-pills .nav-link {
            color: var(--text-dark);
        }

        .product-image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .product-card-admin {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .product-card-admin:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-image-admin {
            height: 150px;
            object-fit: cover;
            width: 100%;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stats-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .action-btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .image-url-input {
            margin-bottom: 10px;
        }

        .color-tag {
            display: inline-block;
            background-color: #e5e7eb;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .color-tag .remove-color {
            margin-left: 5px;
            cursor: pointer;
            color: #ef4444;
        }

        .sync-status {
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .sync-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .sync-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-cog me-2"></i>Administration Boutique
                    </h1>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="products.html" class="btn btn-light btn-sm me-2">
                        <i class="fas fa-store me-1"></i> Voir la boutique
                    </a>
                    <button class="btn btn-warning btn-sm" id="syncNowBtn">
                        <i class="fas fa-sync me-1"></i> Synchroniser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status -->
    <div class="container mt-3">
        <div id="syncStatus" class="sync-status d-none">
            <!-- Le statut de synchronisation sera affich√© ici -->
        </div>
    </div>

    <!-- Admin Content -->
    <div class="container my-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="admin-sidebar">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#products" data-bs-toggle="tab">
                                <i class="fas fa-box me-2"></i> Gestion des produits
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#stats" data-bs-toggle="tab">
                                <i class="fas fa-chart-bar me-2"></i> Statistiques
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#backup" data-bs-toggle="tab">
                                <i class="fas fa-download me-2"></i> Sauvegarde
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="tab-content">
                    <!-- Products Tab -->
                    <div class="tab-pane fade show active" id="products">
                        <div class="admin-content">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2 class="h4 mb-0">Gestion des produits</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                                    <i class="fas fa-plus me-1"></i> Ajouter un produit
                                </button>
                            </div>

                            <!-- Products List -->
                            <div class="row" id="products-list">
                                <div class="col-12 text-center">
                                    <div class="loading"></div>
                                    <p class="text-muted mt-3">Chargement des produits...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Tab -->
                    <div class="tab-pane fade" id="stats">
                        <div class="admin-content">
                            <h2 class="h4 mb-4">Statistiques</h2>
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <div class="stats-card">
                                        <div class="stats-number" id="total-products">0</div>
                                        <div class="stats-label">Produits total</div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="stats-card">
                                        <div class="stats-number" id="homme-products">0</div>
                                        <div class="stats-label">Produits Homme</div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="stats-card">
                                        <div class="stats-number" id="femme-products">0</div>
                                        <div class="stats-label">Produits Femme</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Statut de synchronisation</h5>
                                            <p class="card-text" id="firebaseStatus">Connexion en cours...</p>
                                            <div class="progress mb-3">
                                                <div id="syncProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="lastSync">Derni√®re synchronisation: --</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Tab -->
                    <div class="tab-pane fade" id="backup">
                        <div class="admin-content">
                            <h2 class="h4 mb-4">Sauvegarde et restauration</h2>
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Sauvegarder les donn√©es</h5>
                                            <p class="card-text">T√©l√©chargez un fichier de sauvegarde contenant tous vos produits.</p>
                                            <button class="btn btn-primary" id="export-data">
                                                <i class="fas fa-download me-1"></i> Exporter les donn√©es
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Restaurer les donn√©es</h5>
                                            <p class="card-text">Importez un fichier de sauvegarde pour restaurer vos produits.</p>
                                            <div class="mb-3">
                                                <input type="file" class="form-control" id="import-file" accept=".json">
                                            </div>
                                            <button class="btn btn-success" id="import-data">
                                                <i class="fas fa-upload me-1"></i> Importer les donn√©es
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Forcer la synchronisation</h5>
                                            <p class="card-text">Synchroniser manuellement avec Firebase.</p>
                                            <button class="btn btn-info w-100" id="force-sync">
                                                <i class="fas fa-sync me-1"></i> Synchroniser maintenant
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">R√©initialiser</h5>
                                            <p class="card-text">Remettre √† z√©ro tous les produits.</p>
                                            <button class="btn btn-danger w-100" id="reset-data">
                                                <i class="fas fa-trash me-1"></i> R√©initialiser les donn√©es
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Attention :</strong> L'importation de donn√©es √©crasera toutes les donn√©es actuelles.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Ajouter un produit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productName" class="form-label">Nom du produit *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productCategory" class="form-label">Cat√©gorie *</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">S√©lectionner une cat√©gorie</option>
                                    <option value="homme">Homme</option>
                                    <option value="femme">Femme</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productPrice" class="form-label">Prix (DT) *</label>
                                <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productDiscount" class="form-label">Remise (%)</label>
                                <input type="number" class="form-control" id="productDiscount" min="0" max="100" value="0">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productIsNew">
                                <label class="form-check-label" for="productIsNew">
                                    Marquer comme nouveau produit
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Images du produit</label>
                            <div id="imageUrlsContainer">
                                <!-- Les champs d'URL d'image seront ajout√©s ici dynamiquement -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addImageUrl">
                                <i class="fas fa-plus me-1"></i> Ajouter une image
                            </button>
                            
                            <div id="imagePreview" class="mt-3">
                                <!-- Aper√ßu des images sera affich√© ici -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Couleurs disponibles</label>
                            <div id="colorsContainer">
                                <!-- Les tags de couleur seront ajout√©s ici dynamiquement -->
                            </div>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="newColor" placeholder="Ajouter une couleur">
                                <button type="button" class="btn btn-outline-secondary" id="addColor">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveProduct">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    √ätes-vous s√ªr de vouloir supprimer ce produit ? Cette action est irr√©versible.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Configuration Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC9m0oGpt0nFABacCNsmD1SaYhGZbVnzsA",
        authDomain: "bt-sp-b3ce3.firebaseapp.com",
        projectId: "bt-sp-b3ce3",
        storageBucket: "bt-sp-b3ce3.firebasestorage.app",
        messagingSenderId: "1072895717676",
        appId: "1:1072895717676:web:bace267352a7941c1dfc89"
    };

    // Initialiser Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    // Donn√©es par d√©faut des produits
    const defaultProducts = [
        {
            name: "Ensemble surv√™tement homme",
            category: "homme",
            price: 45,
            images: [
                "https://res.cloudinary.com/dctqq99vw/image/upload/v1764157329/3_px1x8l.jpg",
                "https://res.cloudinary.com/dctqq99vw/image/upload/v1764157327/2_hl5ajb.jpg",
                "https://res.cloudinary.com/dctqq99vw/image/upload/v1764157326/1_lvki0b.jpg"
            ],
            colors: ["Gris", "Rouge", "Noir"],
            isNew: true,
            discount: 0
        },
        {
            name: "T‚Äëshirt sport homme",
            category: "homme",
            price: 50,
            image: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            isNew: false,
            discount: 30
        },
        {
            name: "Pantalon de jogging homme",
            category: "homme",
            price: 120,
            image: "https://images.unsplash.com/photo-1556821840-3a63f95609a7?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            isNew: false,
            discount: 25
        },
        {
            name: "Short running homme",
            category: "homme",
            price: 100,
            image: "https://res.cloudinary.com/dctqq99vw/image/upload/v1764156846/veste_zkjzot.jpg",
            isNew: false,
            discount: 25
        },
        {
            name: "Legging Yoga Premium",
            category: "femme",
            price: 65,
            image: "https://res.cloudinary.com/dctqq99vw/image/upload/v1764166809/fm_cln9da.jpg",
            isNew: true,
            discount: 0
        },
        {
            name: "T-Shirt Fitness Dry",
            category: "femme",
            price: 42,
            image: "https://res.cloudinary.com/dctqq99vw/image/upload/v1764166809/fm_cln9da.jpg",
            isNew: true,
            discount: 0
        },
        {
            name: "Ensemble Fitness Pro",
            category: "femme",
            price: 95,
            image: "https://res.cloudinary.com/dctqq99vw/image/upload/v1764166809/fm_cln9da.jpg",
            isNew: true,
            discount: 0
        },
        {
            name: "Short Training Fit",
            category: "femme",
            price: 55,
            image: "https://res-console.cloudinary.com/dctqq99vw/thumbnails/v1/image/upload/v1764155114/U2hvcnRfRmVtbWVfd2hpdnpp/drilldown",
            isNew: false,
            discount: 50
        }
    ];

    class AdminPanel {
        constructor() {
            this.db = firebase.firestore();
            this.products = [];
            this.currentProductId = null;
            this.unsubscribe = null;
            this.init();
        }

        async init() {
            await this.loadProducts();
            this.setupEventListeners();
            this.updateStats();
            this.listenToChanges();
            this.updateSyncStatus('‚úÖ Connect√© √† Firebase', 'sync-success');
        }

        // Charger les produits depuis Firebase
        async loadProducts() {
            try {
                const snapshot = await this.db.collection('products').get();
                
                if (!snapshot.empty) {
                    this.products = snapshot.docs.map(doc => ({
                        id: doc.id, // Utiliser l'ID Firebase
                        ...doc.data()
                    }));
                    this.displayProducts();
                    this.updateSyncStatus(`‚úÖ ${this.products.length} produits charg√©s`, 'sync-success');
                } else {
                    // Si pas de donn√©es, initialiser avec les produits par d√©faut
                    await this.initializeDefaultProducts();
                }
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
                this.updateSyncStatus('‚ùå Erreur de connexion Firebase', 'sync-error');
                this.products = [];
                this.displayProducts();
            }
        }

        // M√©thode pour initialiser les produits par d√©faut
        async initializeDefaultProducts() {
            try {
                const batch = this.db.batch();
                
                defaultProducts.forEach(product => {
                    const docRef = this.db.collection('products').doc(); // Firebase g√©n√®re l'ID
                    batch.set(docRef, product);
                });
                
                await batch.commit();
                
                // Recharger les produits
                const snapshot = await this.db.collection('products').get();
                this.products = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                this.displayProducts();
                this.updateSyncStatus('‚úÖ Donn√©es initiales cr√©√©es', 'sync-success');
            } catch (error) {
                console.error('Erreur initialisation donn√©es:', error);
                this.updateSyncStatus('‚ùå Erreur cr√©ation donn√©es initiales', 'sync-error');
            }
        }

        // √âcouter les changements en temps r√©el
        listenToChanges() {
            this.unsubscribe = this.db.collection('products').onSnapshot(snapshot => {
                this.products = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                this.displayProducts();
                this.updateStats();
                this.updateLastSync();
            }, error => {
                console.error('Erreur √©coute Firebase:', error);
                this.updateSyncStatus('‚ùå Erreur de synchronisation', 'sync-error');
            });
        }

        // Sauvegarder tous les produits dans Firebase
        async saveAllToFirebase() {
            try {
                // Supprimer tous les documents existants
                const snapshot = await this.db.collection('products').get();
                const batch = this.db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Recr√©er tous les produits avec de nouveaux IDs Firebase
                const newBatch = this.db.batch();
                this.products.forEach(product => {
                    const docRef = this.db.collection('products').doc();
                    const { id, ...productData } = product;
                    newBatch.set(docRef, productData);
                });
                
                await newBatch.commit();
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                return false;
            }
        }

        // Sauvegarder un produit dans Firebase
        async saveProductToFirebase(product) {
            try {
                const { id, ...productData } = product;
                
                // Si c'est un nouveau produit (sans ID Firebase), laisser Firebase g√©n√©rer l'ID
                if (!id) {
                    await this.db.collection('products').add(productData);
                    return true;
                } else {
                    // Si c'est une modification, utiliser l'ID existant
                    await this.db.collection('products').doc(id).set(productData);
                    return true;
                }
            } catch (error) {
                console.error('Erreur sauvegarde produit:', error);
                return false;
            }
        }

        // Supprimer un produit de Firebase
        async deleteProductFromFirebase(productId) {
            try {
                await this.db.collection('products').doc(productId).delete();
                return true;
            } catch (error) {
                console.error('Erreur suppression produit:', error);
                return false;
            }
        }

        // Afficher tous les produits
        displayProducts() {
            const container = document.getElementById('products-list');
            
            if (this.products.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h4 class="fw-bold mb-3">Aucun produit</h4>
                        <p class="text-muted mb-4">
                            Commencez par ajouter votre premier produit.
                        </p>
                    </div>
                `;
                return;
            }

            container.innerHTML = this.products.map(product => {
                const hasDiscount = product.discount > 0;
                const discountPrice = hasDiscount ? (product.price * (1 - product.discount / 100)).toFixed(2) : product.price;
                const mainImage = product.images ? product.images[0] : product.image;

                return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="product-card-admin h-100">
                            <img src="${mainImage}" class="product-image-admin" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Non+Disponible'">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="mb-0">${product.name}</h5>
                                    <span class="badge ${product.category === 'homme' ? 'bg-primary' : 'bg-danger'}">
                                        ${product.category}
                                    </span>
                                </div>
                                <p class="text-muted small mb-2">${product.colors ? product.colors.join(', ') : 'Aucune couleur sp√©cifi√©e'}</p>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        ${hasDiscount ? `
                                            <span class="fw-bold text-primary">${discountPrice} DT</span>
                                            <span class="text-muted text-decoration-line-through ms-1">${product.price} DT</span>
                                            <span class="badge bg-danger ms-1">-${product.discount}%</span>
                                        ` : `
                                            <span class="fw-bold text-primary">${product.price} DT</span>
                                        `}
                                    </div>
                                    ${product.isNew ? '<span class="badge bg-success">Nouveau</span>' : ''}
                                </div>
                                <div class="d-flex">
                                    <button class="btn btn-sm btn-outline-primary action-btn edit-product" data-id="${product.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger action-btn delete-product" data-id="${product.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mettre √† jour les statistiques
        updateStats() {
            const totalProducts = this.products.length;
            const hommeProducts = this.products.filter(p => p.category === 'homme').length;
            const femmeProducts = this.products.filter(p => p.category === 'femme').length;

            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('homme-products').textContent = hommeProducts;
            document.getElementById('femme-products').textContent = femmeProducts;

            document.getElementById('firebaseStatus').textContent = 
                `‚úÖ ${totalProducts} produits synchronis√©s - Temps r√©el activ√©`;
        }

        // Mettre √† jour le statut de synchronisation
        updateSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status ${type}`;
            statusElement.classList.remove('d-none');
            
            setTimeout(() => {
                statusElement.classList.add('d-none');
            }, 5000);
        }

        // Mettre √† jour la derni√®re synchronisation
        updateLastSync() {
            const now = new Date();
            document.getElementById('lastSync').textContent = 
                `Derni√®re synchronisation: ${now.toLocaleString()}`;
        }

        // Ouvrir le modal pour ajouter un produit
        openAddProductModal() {
            document.getElementById('productModalLabel').textContent = 'Ajouter un produit';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('imageUrlsContainer').innerHTML = '';
            document.getElementById('colorsContainer').innerHTML = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            // Ajouter un champ d'URL d'image par d√©faut
            this.addImageUrlField();
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        // Ouvrir le modal pour modifier un produit
        openEditProductModal(productId) {
            const product = this.products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('productModalLabel').textContent = 'Modifier le produit';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDiscount').value = product.discount || 0;
            document.getElementById('productIsNew').checked = product.isNew || false;

            // G√©rer les images
            document.getElementById('imageUrlsContainer').innerHTML = '';
            const images = product.images || [product.image];
            images.forEach(url => this.addImageUrlField(url));
            
            // G√©rer les couleurs
            document.getElementById('colorsContainer').innerHTML = '';
            if (product.colors) {
                product.colors.forEach(color => this.addColorTag(color));
            }
            
            // Afficher l'aper√ßu des images
            this.updateImagePreview();

            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        // Ajouter un champ d'URL d'image
        addImageUrlField(url = '') {
            const container = document.getElementById('imageUrlsContainer');
            const index = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'input-group image-url-input';
            div.innerHTML = `
                <input type="url" class="form-control" value="${url}" placeholder="URL de l'image" data-index="${index}">
                <button type="button" class="btn btn-outline-danger remove-image-url">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(div);
            
            // Mettre √† jour l'aper√ßu quand l'URL change
            const input = div.querySelector('input');
            input.addEventListener('input', () => this.updateImagePreview());
        }

        // Ajouter un tag de couleur
        addColorTag(color) {
            const container = document.getElementById('colorsContainer');
            
            const tag = document.createElement('span');
            tag.className = 'color-tag';
            tag.innerHTML = `
                ${color}
                <span class="remove-color">
                    <i class="fas fa-times"></i>
                </span>
            `;
            
            container.appendChild(tag);
        }

        // Mettre √† jour l'aper√ßu des images
        updateImagePreview() {
            const container = document.getElementById('imagePreview');
            const inputs = document.querySelectorAll('#imageUrlsContainer input');
            
            container.innerHTML = '';
            
            inputs.forEach(input => {
                if (input.value) {
                    const img = document.createElement('img');
                    img.src = input.value;
                    img.className = 'product-image-preview me-2 mb-2';
                    img.alt = 'Aper√ßu';
                    img.onerror = function() {
                        this.style.display = 'none';
                    };
                    container.appendChild(img);
                }
            });
        }

        // Sauvegarder un produit (ajout ou modification)
        async saveProduct() {
            // R√©cup√©rer les donn√©es du formulaire
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const discount = parseInt(document.getElementById('productDiscount').value) || 0;
            const isNew = document.getElementById('productIsNew').checked;
            
            // R√©cup√©rer les URLs des images
            const imageInputs = document.querySelectorAll('#imageUrlsContainer input');
            const images = Array.from(imageInputs)
                .map(input => input.value.trim())
                .filter(url => url !== '');
            
            // R√©cup√©rer les couleurs
            const colorTags = document.querySelectorAll('#colorsContainer .color-tag');
            const colors = Array.from(colorTags)
                .map(tag => tag.textContent.trim().replace('√ó', '').trim());
            
            // Validation
            if (!name || !category || isNaN(price) || images.length === 0) {
                alert('Veuillez remplir tous les champs obligatoires et ajouter au moins une image.');
                return;
            }
            
            // Pr√©parer l'objet produit
            const productData = {
                name,
                category,
                price,
                discount,
                isNew,
                colors: colors.length > 0 ? colors : undefined
            };
            
            // G√©rer les images (compatibilit√© avec l'ancienne structure)
            if (images.length === 1) {
                productData.image = images[0];
            } else {
                productData.images = images;
            }
            
            // Ajouter l'ID seulement si c'est une modification
            if (id) {
                productData.id = id;
            }
            
            // Sauvegarder dans Firebase
            const success = await this.saveProductToFirebase(productData);
            
            if (success) {
                // Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
                
                this.updateSyncStatus('‚úÖ Produit sauvegard√© avec succ√®s', 'sync-success');
            } else {
                alert('Erreur lors de la sauvegarde. Veuillez r√©essayer.');
            }
        }

        // Supprimer un produit
        async deleteProduct(productId) {
            const success = await this.deleteProductFromFirebase(productId);
            
            if (success) {
                this.updateSyncStatus('‚úÖ Produit supprim√© avec succ√®s', 'sync-success');
            } else {
                alert('Erreur lors de la suppression. Veuillez r√©essayer.');
            }
        }

        // Exporter les donn√©es
        exportData() {
            const dataStr = JSON.stringify(this.products, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'boutique_produits_backup.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.updateSyncStatus('‚úÖ Donn√©es export√©es avec succ√®s', 'sync-success');
        }

        // Importer les donn√©es
        importData(file) {
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const importedProducts = JSON.parse(e.target.result);
                    
                    // Validation basique des donn√©es
                    if (!Array.isArray(importedProducts)) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Demander confirmation avant d'√©craser les donn√©es
                    if (confirm(`Cette action √©crasera ${this.products.length} produits actuels avec ${importedProducts.length} nouveaux produits. √ätes-vous s√ªr ?`)) {
                        this.products = importedProducts;
                        const success = await this.saveAllToFirebase();
                        
                        if (success) {
                            this.updateSyncStatus(`‚úÖ ${importedProducts.length} produits import√©s avec succ√®s`, 'sync-success');
                        } else {
                            alert('Erreur lors de l\'importation');
                        }
                    }
                } catch (error) {
                    alert('Erreur lors de l\'importation: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // R√©initialiser les donn√©es
        async resetData() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser tous les produits ? Cette action est irr√©versible.')) {
                this.products = [];
                const success = await this.initializeDefaultProducts();
                
                if (success) {
                    this.updateSyncStatus('‚úÖ Donn√©es r√©initialis√©es avec succ√®s', 'sync-success');
                } else {
                    alert('Erreur lors de la r√©initialisation');
                }
            }
        }

        // Configurer les √©couteurs d'√©v√©nements
        setupEventListeners() {
            // Bouton pour ajouter un produit
            document.querySelector('[data-bs-target="#productModal"]').addEventListener('click', () => {
                this.openAddProductModal();
            });
            
            // Boutons pour modifier/supprimer des produits (d√©l√©gu√©s d'√©v√©nements)
            document.getElementById('products-list').addEventListener('click', (e) => {
                if (e.target.closest('.edit-product')) {
                    const productId = e.target.closest('.edit-product').getAttribute('data-id');
                    this.openEditProductModal(productId);
                }
                
                if (e.target.closest('.delete-product')) {
                    const productId = e.target.closest('.delete-product').getAttribute('data-id');
                    this.currentProductId = productId;
                    
                    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    modal.show();
                }
            });
            
            // Confirmation de suppression
            document.getElementById('confirmDelete').addEventListener('click', () => {
                this.deleteProduct(this.currentProductId);
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
            });
            
            // Sauvegarder un produit
            document.getElementById('saveProduct').addEventListener('click', () => {
                this.saveProduct();
            });
            
            // Ajouter un champ d'URL d'image
            document.getElementById('addImageUrl').addEventListener('click', () => {
                this.addImageUrlField();
            });
            
            // Supprimer un champ d'URL d'image (d√©l√©gu√© d'√©v√©nements)
            document.getElementById('imageUrlsContainer').addEventListener('click', (e) => {
                if (e.target.closest('.remove-image-url')) {
                    e.target.closest('.image-url-input').remove();
                    this.updateImagePreview();
                }
            });
            
            // Ajouter une couleur
            document.getElementById('addColor').addEventListener('click', () => {
                const newColorInput = document.getElementById('newColor');
                const color = newColorInput.value.trim();
                
                if (color) {
                    this.addColorTag(color);
                    newColorInput.value = '';
                }
            });
            
            // Supprimer une couleur (d√©l√©gu√© d'√©v√©nements)
            document.getElementById('colorsContainer').addEventListener('click', (e) => {
                if (e.target.closest('.remove-color')) {
                    e.target.closest('.color-tag').remove();
                }
            });
            
            // Entr√©e pour ajouter une couleur
            document.getElementById('newColor').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('addColor').click();
                }
            });
            
            // Exporter les donn√©es
            document.getElementById('export-data').addEventListener('click', () => {
                this.exportData();
            });
            
            // Importer les donn√©es
            document.getElementById('import-data').addEventListener('click', () => {
                const fileInput = document.getElementById('import-file');
                if (fileInput.files.length > 0) {
                    this.importData(fileInput.files[0]);
                } else {
                    alert('Veuillez s√©lectionner un fichier √† importer.');
                }
            });

            // Synchronisation manuelle
            document.getElementById('force-sync').addEventListener('click', async () => {
                this.updateSyncStatus('üîÑ Synchronisation en cours...', 'sync-success');
                const success = await this.saveAllToFirebase();
                if (success) {
                    this.updateSyncStatus('‚úÖ Synchronisation termin√©e', 'sync-success');
                } else {
                    this.updateSyncStatus('‚ùå Erreur de synchronisation', 'sync-error');
                }
            });

            // R√©initialiser les donn√©es
            document.getElementById('reset-data').addEventListener('click', () => {
                this.resetData();
            });

            // Synchronisation rapide
            document.getElementById('syncNowBtn').addEventListener('click', async () => {
                this.updateSyncStatus('üîÑ Synchronisation en cours...', 'sync-success');
                const success = await this.saveAllToFirebase();
                if (success) {
                    this.updateSyncStatus('‚úÖ Synchronisation termin√©e', 'sync-success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    this.updateSyncStatus('‚ùå Erreur de synchronisation', 'sync-error');
                }
            });
        }
    }

    // D√©marrer l'application
    document.addEventListener('DOMContentLoaded', () => {
        new AdminPanel();
    });
</script>
</body>
</html>